#include <stdio.h>
#include <stdint.h>
#include <string.h>
#include <unistd.h>
#include <sys/reboot.h>
#include "bbry_vs.h"

#define NV_OEM_ITEM_1_I 6853

uint8_t oem_item_1[] = {
	0x65, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x27, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00,
	0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00
};

int main()
{
	printf("Wait for modem...\n");

	wait_for_modem();

	uint8_t data[128];
	memset(data, 0, sizeof(data));
	uint32_t data_len = 0;
	int status = 0;
	int ret = radionv_qct_readnv_item(NV_OEM_ITEM_1_I, data, &data_len, &status);
	if (ret == 1) {
		*(uint32_t *) data = 0x65;
	} else {
		memcpy(data, oem_item_1, sizeof(oem_item_1));
		data_len = sizeof(oem_item_1);
	}

	ret = radionv_qct_writenv_item(NV_OEM_ITEM_1_I, oem_item_1, sizeof(oem_item_1), &status);
	if (ret != 1) {
		printf("Failed to write oem item 1\n");
		return -1;
	}
	
	bbry_efs_force_sync_util();
	
	sync();
	reboot(RB_AUTOBOOT);
	
	return 0;
}
